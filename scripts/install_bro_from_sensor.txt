sudo su -
. /etc/ntfk.conf
# Stop cron
service cron stop

# stop all packet captures
killall tcpdump

# prepare for new mount point
mkdir /nsm
touch /nsm/NOT_MOUNTED

# reformat /dev/dsa1 from vfat to ext4
umount /dev/sda1
fdisk /dev/sda
 --> d
 --> n
 --> w
mkfs.ext4 /dev/sda

su - ntfk
. /etc/ntfk.conf
scp $NTFK_MASTER:files/etc/fstab.ext4 files/etc/
exit

cp /home/ntfk/files/etc/fstab.ext4 /etc/fstab

# mount new ext4 partition
mount /nsm

# pull compiled bro from NTFK_MASTER
mkdir -p /nsm/download
su - ntfk
. /etc/ntfk.conf
scp $NTFK_MASTER:archive/ntfk0001.opt.bro-2.4.1.tgz /nsm/download
exit

# install bro dependencies
apt-get -y install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev htop vim libgeoip-dev ethtool git tshark tcpdump nmap python-pip autoconf libtool

cd /
tar -xzvf /nsm/download/ntfk0001.opt.bro-2.4.1.tgz
cd /opt/bro-2.4.1

# install bro
make install

# copy node.cfg from NTFK_MASTER
su - ntfk
. /etc/ntfk.conf
rsync -vr $NTFK_MASTER:files/usr/local/bro files/usr/local/
exit

cp /home/ntfk/files/usr/local/bro/etc/node.cfg /usr/local/bro/etc/node.cfg

# start bro and check status
broctl deploy
broctl status
